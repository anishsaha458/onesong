# render.yaml — OneSong API v4.4
# ─────────────────────────────────────────────────────────────
# FIXES vs previous:
# [R1] env: python → runtime: python  (Render renamed this key; the old value
#      causes a silent build failure with a misleading "invalid service" error)
# [R2] Added apt-get install ffmpeg — without this, yt-dlp cannot transcode
#      audio and every /stream and /audio_analysis call fails silently
# [R3] essentia install is non-fatal (|| true). Wheels don't exist for every
#      Python 3.11.x patch on Render's Ubuntu 22 image. Server degrades
#      gracefully to synthetic fallback analysis when missing.
# [R4] numpy pinned to 1.26.4 — essentia 2.1b6 is incompatible with numpy 2.x
# [R5] plan: starter — free tier (512MB RAM) OOMs during Essentia analysis of
#      a 4-min track. Starter (1GB) is the minimum safe tier for real analysis.
#      Switch back to free if you accept analysis-always-synthetic.
# [R6] PYTHON_VERSION set explicitly for reliable wheel resolution
# [R7] healthCheckPath added so Render waits for /health 200 before routing traffic

services:
  - type: web
    name: onesong-api
    runtime: python          # FIX [R1]: was "env: python"
    region: oregon
    plan: starter            # FIX [R5]: free tier OOMs on Essentia

    buildCommand: |
      set -e

      # FIX [R2]: ffmpeg MUST be installed before pip deps.
      # yt-dlp's --audio-format wav postprocessor requires ffmpeg on PATH.
      # Without this, Essentia's MonoLoader raises "unsupported format"
      # on raw WebM, and every /stream download is unconverted.
      apt-get update -qq
      apt-get install -y --no-install-recommends ffmpeg libsndfile1
      apt-get clean && rm -rf /var/lib/apt/lists/*

      pip install --upgrade pip

      # Core deps — all have reliable binary wheels for Python 3.11 on Linux
      pip install \
        "fastapi==0.111.0" \
        "uvicorn[standard]==0.29.0" \
        "PyJWT==2.8.0" \
        "bcrypt==4.1.3" \
        "python-multipart==0.0.9" \
        "httpx==0.27.0" \
        "psycopg2-binary==2.9.9" \
        "numpy==1.26.4" \
        "yt-dlp==2024.5.27" \
        "email-validator==2.1.1" \
        "pydantic[email]==2.7.1"

      # FIX [R3]: essentia is optional — non-fatal on wheel unavailability
      pip install "essentia==2.1b6.dev1110" || \
        echo "[build] essentia wheel unavailable — synthetic fallback active"

      # Smoke-test: verify all hard-required imports load before traffic is routed
      python -c "
      import fastapi, uvicorn, jwt, bcrypt, psycopg2, httpx, numpy
      import yt_dlp
      print(f'[build] imports OK  numpy={numpy.__version__}')
      "

    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT --workers 1 --log-level info

    healthCheckPath: /health   # FIX [R7]

    envVars:
      - key: JWT_SECRET
        generateValue: true    # Render generates a secure random value automatically
      - key: DATABASE_URL
        sync: false            # Set in Render dashboard → Environment
      - key: LASTFM_API_KEY
        sync: false            # Optional
      - key: PYTHON_VERSION
        value: "3.11.9"        # FIX [R6]