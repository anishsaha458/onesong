# render.yaml — OneSong API v4.8
#
# WHY ESSENTIA WAS FALSE EVEN AFTER INSTALLING:
#   The wheel installs successfully (no pip error) but the .so fails to
#   load at import time because of missing runtime shared libraries.
#   Essentia requires: libsndfile1, libeigen3, libfftw3, libavcodec
#   The || true was swallowing both pip errors AND import errors silently.
#
# FIXES:
#   1. Expanded apt-get to include all essentia runtime dependencies
#   2. Upgraded to essentia==2.1b6.dev1389 (July 2025) — freshest cp311 wheel
#   3. Build now tests `python -c "import essentia"` explicitly and prints
#      the actual error if it fails, so we can see what's wrong in logs
#   4. PYTHON_VERSION stays as value: (not sync:) so Render creates venv
#      with the right interpreter before buildCommand runs

services:
  - type: web
    name: onesong-api
    runtime: python
    region: oregon
    plan: starter

    buildCommand: |
      set -e

      echo "=== Python version ==="
      python --version

      echo "=== System deps (essentia runtime requirements) ==="
      apt-get update -qq
      apt-get install -y --no-install-recommends \
        ffmpeg \
        libsndfile1 \
        libfftw3-dev \
        libeigen3-dev \
        libavcodec-dev \
        libavformat-dev \
        libavutil-dev \
        libtag1-dev \
        libsamplerate0
      apt-get clean && rm -rf /var/lib/apt/lists/*

      echo "=== Python deps ==="
      pip install --upgrade pip
      pip install -r requirements.txt

      echo "=== Essentia (latest cp311 wheel — dev1389, July 2025) ==="
      pip install "essentia==2.1b6.dev1389"

      echo "=== Verify essentia imports cleanly ==="
      python -c "
      import essentia
      import essentia.standard as es
      print(f'essentia OK: {essentia.__version__}')
      # Quick sanity check that core algorithms load
      _ = es.MonoLoader
      _ = es.RhythmExtractor2013
      _ = es.MelBands
      print('essentia algorithms OK')
      "

      echo "=== Full smoke test ==="
      python -c "
      import shutil
      import fastapi, uvicorn, jwt, bcrypt, psycopg2, httpx, numpy, yt_dlp
      print(f'All imports OK  numpy={numpy.__version__}')
      print(f'ffmpeg: {shutil.which(\"ffmpeg\")}')
      print(f'yt-dlp: {shutil.which(\"yt-dlp\")}')
      "

    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT --workers 1 --log-level info
    healthCheckPath: /health

    envVars:
      - key: PYTHON_VERSION
        value: "3.11.9"

      - key: JWT_SECRET
        generateValue: true
      - key: DATABASE_URL
        sync: false
      - key: LASTFM_API_KEY
        sync: false