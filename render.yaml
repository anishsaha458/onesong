# render.yaml — OneSong API v4.5
# ─────────────────────────────────────────────────────────────
# ROOT CAUSE OF LATEST BUILD FAILURE:
#   Render defaulted to Python 3.14. pydantic-core 2.18.2 has no wheel
#   for 3.14 and tried to compile from Rust source — which fails because
#   Render's build filesystem is read-only (/usr/local/cargo = EROFS).
#
# FIX: `pythonVersion: "3.11.9"` is the ONLY key Render's build system
#   reliably reads to select the CPython version. runtime.txt and the
#   PYTHON_VERSION env var are advisory only and were ignored.
#
# All pinned versions below have confirmed manylinux wheels for cp311.

services:
  - type: web
    name: onesong-api
    runtime: python
    pythonVersion: "3.11.9"      # ← THE critical fix. Forces cp311 interpreter.
    region: oregon
    plan: starter                # free tier (512MB) OOMs on Essentia analysis

    buildCommand: |
      set -e

      echo "=== Python version check ==="
      python --version

      echo "=== Installing system deps (ffmpeg) ==="
      apt-get update -qq
      apt-get install -y --no-install-recommends ffmpeg libsndfile1
      apt-get clean && rm -rf /var/lib/apt/lists/*

      echo "=== Upgrading pip ==="
      pip install --upgrade pip

      echo "=== Installing Python deps ==="
      pip install -r requirements.txt

      echo "=== Installing essentia (non-fatal if wheel missing) ==="
      pip install "essentia==2.1b6.dev1110" || \
        echo "[build] essentia wheel unavailable — synthetic analysis fallback will be used"

      echo "=== Smoke test ==="
      python -c "
      import sys
      assert sys.version_info[:2] == (3, 11), f'Wrong Python: {sys.version}'
      import fastapi, uvicorn, jwt, bcrypt, psycopg2, httpx, numpy, yt_dlp
      print(f'All imports OK  python={sys.version}  numpy={numpy.__version__}')
      "

    startCommand: uvicorn main:app --host 0.0.0.0 --port $PORT --workers 1 --log-level info

    healthCheckPath: /health

    envVars:
      - key: JWT_SECRET
        generateValue: true
      - key: DATABASE_URL
        sync: false
      - key: LASTFM_API_KEY
        sync: false